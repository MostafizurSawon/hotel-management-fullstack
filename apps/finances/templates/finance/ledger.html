{% extends layout_path %}
{% load static %}
{% load humanize %}
{% block title %}Ledger{% endblock %}

{% block content %}
<style>
  .ledger-table th, .ledger-table td {
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
    font-size: 14px;
    padding: 6px;
  }

  .col-name     { width: 160px; }
  .col-amount   { width: 120px; white-space: nowrap; }
  .col-balance  { width: 140px; white-space: nowrap; }

  .col-sl       { width: 40px; }
  .col-date     { width: 90px; }
  .col-category { width: 100px; }

  .text-success { color: green; }
  .text-danger  { color: red; }
</style>

<div class="content-header">
  <h4 class="mb-3">Ledger</h4>
</div>

<!-- Filters -->
<div class="card p-3 mb-4">
  <form method="get" class="row g-2">
    <div class="col-md-4">
      <input type="text" name="search" class="form-control"
             value="{{ search }}" placeholder="Search booking / expense">
    </div>

    <div class="col-md-3">
      <select name="expense_category" class="form-select">
        <option value="">Expense Category</option>
        {% for cat in expense_categories %}
          <option value="{{ cat.id }}"
            {% if expense_category_filter == cat.id|stringformat:"s" %}selected{% endif %}>
            {{ cat.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
    </div>

    <div class="col-md-2">
      <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
    </div>

    <div class="col-md-1 d-flex gap-1">
      <button class="btn btn-primary w-100">Go</button>
      <a href="{% url 'ledger_view' %}" class="btn btn-secondary">â†º</a>
    </div>
  </form>
</div>

<!-- Export -->
<div class="mb-3">
  <a href="{% url 'ledger_export_csv' %}?{{ request.GET.urlencode }}"
     class="btn btn-sm btn-primary">ðŸ“¥ CSV</a>

  {% comment %} <a href="{% url 'ledger_export_pdf' %}?{{ request.GET.urlencode }}"
     class="btn btn-sm btn-success" target="_blank">ðŸ“„ PDF</a> {% endcomment %}

  <a href="{% url 'ledger_print' %}?{{ request.GET.urlencode }}"
    target="_blank"
    class="btn btn-sm btn-success">
    ðŸ“„ Print / PDF
  </a>
</div>

<!-- Ledger Table -->
<div class="card p-3">
  <h5 class="text-center mb-3">Booking Income vs Expense</h5>

  <div class="table-responsive">
    <table class="table table-bordered ledger-table">
      <thead class="table-light">
        <tr>
          <th colspan="5">Income (Booking)</th>
          <th colspan="5">Expense</th>
          <th rowspan="2">Balance</th>
        </tr>
        <tr>
          <th class="col-sl">SL</th>
          <th class="col-date">Date</th>
          <th class="col-category">Category</th>
          <th class="col-name">Name</th>
          <th class="col-amount">Amount</th>

          <th class="col-sl">SL</th>
          <th class="col-date">Date</th>
          <th class="col-category">Category</th>
          <th class="col-name">Name</th>
          <th class="col-amount">Amount</th>
        </tr>
      </thead>

      <tbody>
        {% for income, expense in combined_data %}
        <tr>
          <!-- INCOME -->
          {% if income %}
            <td>{{ forloop.counter }}</td>
            <td>{{ income.received_at|date:"d/m/Y" }}</td>
            <td>Booking</td>
            <td class="text-start">
              <strong>
                {{ income.booking.guest.full_name|default:"Guest" }}
              </strong><br>

              {% if income.booking.guest.phone_number %}
                ðŸ“ž {{ income.booking.guest.phone_number }}<br>
              {% endif %}

              <small class="">
                Room: {{ income.booking.room.room_number }}
                | {{ income.booking.check_in|date:"d/m/Y" }}
                â†’ {{ income.booking.check_out|date:"d/m/Y" }}
              </small>
            </td>
            <td class="text-success">{{ income.amount|intcomma }} à§³</td>
          {% else %}
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          {% endif %}

          <!-- EXPENSE -->
          {% if expense %}
            <td>{{ forloop.counter }}</td>
            <td>{{ expense.date|date:"d/m/Y" }}</td>
            <td>{{ expense.exp_category.name }}</td>
            <td>{{ expense.exp_name }}</td>
            <td class="text-danger">{{ expense.amount|intcomma }} à§³</td>
          {% else %}
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          {% endif %}

          {% if forloop.first %}
          <td rowspan="{{ combined_data|length }}">
            <strong>{{ balance|intcomma }} à§³</strong>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>

      <tfoot>
        <tr>
          <td colspan="4" class="text-end fw-bold text-success">
            Total Income
          </td>
          <td class="fw-bold text-success">
            {{ total_income|intcomma }} à§³
          </td>

          <td></td>

          <td colspan="3" class="text-end fw-bold text-danger">
            Total Expense
          </td>
          <td class="fw-bold text-danger">
            {{ total_expense|intcomma }} à§³
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
{% endblock %}

{% extends layout_path %}
{% load static %}

{% block title %}{{ page_title|default:"My Dashboard" }}{% endblock %}

{% block content %}

<style>
  :root{
    --card-radius: 16px;
    --soft-shadow: 0 10px 30px rgba(0,0,0,.08);
    --soft-shadow-2: 0 6px 16px rgba(0,0,0,.08);
  }

  .hero-wrap{
    position: relative;
    border-radius: var(--card-radius);
    padding: 22px;
    overflow: hidden;
    box-shadow: var(--soft-shadow);
    background: radial-gradient(1000px 300px at 10% 0%, rgba(13,110,253,.18), transparent 55%),
                radial-gradient(900px 260px at 95% 20%, rgba(32,201,151,.16), transparent 55%),
                linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75));
    border: 1px solid rgba(0,0,0,.06);
    backdrop-filter: blur(6px);
  }
  .hero-badge{
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    padding:.35rem .6rem;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,.08);
    background: rgba(255,255,255,.75);
    font-size: .85rem;
  }
  .avatar{
    width: 54px;
    height: 54px;
    border-radius: 14px;
    object-fit: cover;
    box-shadow: var(--soft-shadow-2);
    border: 1px solid rgba(0,0,0,.08);
    background:#fff;
  }
  .stat-card{
    border-radius: var(--card-radius);
    box-shadow: var(--soft-shadow-2);
    border: 1px solid rgba(0,0,0,.06);
    background: #fff;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .stat-card:hover{
    transform: translateY(-2px);
    box-shadow: var(--soft-shadow);
  }
  .muted{ color: rgba(33,37,41,.70); }

  .table-card{
    border-radius: var(--card-radius);
    box-shadow: var(--soft-shadow);
    border: 1px solid rgba(0,0,0,.06);
    overflow: hidden;
    background:#fff;
  }
  .table thead th{
    background: rgba(13,110,253,.06);
    border-bottom: 1px solid rgba(0,0,0,.06);
    font-weight: 600;
    white-space: nowrap;
  }
  .pill{
    font-size: .75rem;
    padding:.25rem .55rem;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,.08);
    white-space: nowrap;
  }
  .pill-success{ background: rgba(25,135,84,.10); color:#198754; }
  .pill-warning{ background: rgba(255,193,7,.14); color:#856404; }
  .pill-secondary{ background: rgba(108,117,125,.12); color:#6c757d; }
</style>

<div class="">
  {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  {% endif %}

  <!-- HERO -->
  <div class="hero-wrap mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        {% if guest and guest.photo %}
          <img class="avatar" src="{{ guest.photo.url }}" alt="Guest photo">
        {% else %}
          <div class="avatar d-flex align-items-center justify-content-center">
            <span class="fw-bold text-primary">
              {{ guest.full_name|default:"G"|slice:":1" }}
            </span>
          </div>
        {% endif %}

        <div>
          <div class="hero-badge mb-2">
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Guest</span>
            <span class="muted">Welcome back</span>
          </div>

          <h4 class="mb-1">
            {{ guest.full_name|default:request.user.get_username }}
          </h4>
          <div class="muted small">
            {% if guest.phone_number %}<span class="me-2"><i class="bx bx-phone"></i> {{ guest.phone_number }}</span>{% endif %}
            {% if guest.email %}<span class="me-2"><i class="bx bx-envelope"></i> {{ guest.email }}</span>{% endif %}
            <span><i class="bx bx-calendar"></i> {{ today|date:"d M Y" }}</span>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <a href="#" class="btn btn-outline-primary">
          <i class="bx bx-user"></i> My Profile
        </a>
        <a href="#" class="btn btn-primary">
          <i class="bx bx-support"></i> Help Desk
        </a>
      </div>
    </div>
  </div>

  <!-- STATS -->
  {% with total=bookings|length %}
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="stat-card p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="muted small">Total Bookings</div>
            <div class="fs-3 fw-bold">{{ total }}</div>
          </div>
          <div class="rounded-3 p-2 bg-primary-subtle text-primary">
            <i class="bx bx-receipt fs-4"></i>
          </div>
        </div>
        <div class="muted small mt-2">Your booking history in this hotel</div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="stat-card p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="muted small">Upcoming / Active</div>
            <div class="fs-3 fw-bold">
              {# fallback: show total for now. you can compute active count in view later #}
              {{ total }}
            </div>
          </div>
          <div class="rounded-3 p-2 bg-success-subtle text-success">
            <i class="bx bx-calendar-check fs-4"></i>
          </div>
        </div>
        <div class="muted small mt-2">Check-in & stay status overview</div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="stat-card p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="muted small">Quick Actions</div>
            <div class="d-flex gap-2 mt-2 flex-wrap">
              <a href="#" class="btn btn-sm btn-outline-secondary"><i class="bx bx-file"></i> Invoice</a>
              <a href="#" class="btn btn-sm btn-outline-secondary"><i class="bx bx-bell"></i> Requests</a>
              <a href="#" class="btn btn-sm btn-outline-secondary"><i class="bx bx-message"></i> Messages</a>
            </div>
          </div>
          <div class="rounded-3 p-2 bg-warning-subtle text-warning">
            <i class="bx bx-grid-alt fs-4"></i>
          </div>
        </div>
        <div class="muted small mt-2">Everything you need in one place</div>
      </div>
    </div>
  </div>
  {% endwith %}

  <!-- BOOKINGS TABLE -->
  <div class="table-card">
    <div class="p-3 border-bottom d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <h5 class="mb-0">My Bookings</h5>
        <div class="muted small">Latest bookings and stay details</div>
      </div>
      <div class="d-flex gap-2">
        {% comment %} <input type="search" class="form-control form-control-sm" placeholder="Search booking..." style="max-width:220px;"> {% endcomment %}
        <input type="search"
          id="bookingSearch"
          class="form-control form-control-sm"
          placeholder="Search room / category..."
          style="max-width:220px;">
        <select id="statusFilter" class="form-select form-select-sm" style="max-width:160px;">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Upcoming">Upcoming</option>
          <option value="Completed">Completed</option>
        </select>
        <button class="btn btn-sm btn-outline-primary"><i class="bx bx-filter"></i> Filter</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Room</th>
            <th>Category</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Status</th>
            <th class="text-end">Amount</th>
            <th class="text-end">Action</th>
          </tr>
        </thead>
        <tbody>
          {% if bookings %}
            {% for b in bookings %}
              <tr>
                <td class="fw-semibold">
                  {{ b.room.room_number|default:"—" }}
                </td>
                <td class="muted">
                  {{ b.room.category.name|default:"—" }}
                </td>
                <td>{{ b.check_in|date:"d M Y" }}</td>
                <td>{{ b.check_out|date:"d M Y" }}</td>

                {# Simple status guess (adjust if you have b.status field) #}
                <td>
                  {% if b.check_in <= today and b.check_out > today %}
                    <span class="pill pill-success">Active</span>
                  {% elif b.check_in > today %}
                    <span class="pill pill-warning">Upcoming</span>
                  {% else %}
                    <span class="pill pill-secondary">Completed</span>
                  {% endif %}
                </td>

                <td class="text-end fw-semibold">
                  {% if b.payment_amount %}৳ {{ b.payment_amount }}{% else %}—{% endif %}
                </td>

                <td class="text-end">
                  {% comment %} <a href="#" class="btn btn-sm btn-primary">
                    <i class="bx bx-show"></i> View
                  </a> {% endcomment %}

                  <a href="#"
                    class="btn btn-sm btn-primary view-booking-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#bookingModal"
                    data-room="{{ b.room.room_number }}"
                    data-category="{{ b.room.category.name }}"
                    data-checkin="{{ b.check_in|date:'d M Y' }}"
                    data-checkout="{{ b.check_out|date:'d M Y' }}"
                    data-amount="{{ b.payment_amount|default:'—' }}"
                    data-status="{% if b.check_in <= today and b.check_out > today %}Active{% elif b.check_in > today %}Upcoming{% else %}Completed{% endif %}">
                    <i class="bx bx-show"></i> View
                  </a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="mb-2">
                  <i class="bx bx-bed fs-1 text-primary"></i>
                </div>
                <h6 class="mb-1">No bookings found</h6>
                <div class="muted small mb-3">When you book a room, it will appear here.</div>
                <a href="#" class="btn btn-outline-primary btn-sm">
                  <i class="bx bx-plus"></i> Make a booking
                </a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title">Booking Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-6">
            <div class="text-muted small">Room</div>
            <div class="fw-semibold" id="m-room"></div>
          </div>
          <div class="col-6">
            <div class="text-muted small">Category</div>
            <div class="fw-semibold" id="m-category"></div>
          </div>

          <div class="col-6">
            <div class="text-muted small">Check-in</div>
            <div id="m-checkin"></div>
          </div>
          <div class="col-6">
            <div class="text-muted small">Check-out</div>
            <div id="m-checkout"></div>
          </div>

          <div class="col-6">
            <div class="text-muted small">Status</div>
            <span class="badge bg-primary" id="m-status"></span>
          </div>
          <div class="col-6">
            <div class="text-muted small">Amount</div>
            <div class="fw-bold">৳ <span id="m-amount"></span></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // -------------------------
  // Booking modal populate
  // -------------------------
  document.querySelectorAll(".view-booking-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.getElementById("m-room").innerText = btn.dataset.room;
      document.getElementById("m-category").innerText = btn.dataset.category;
      document.getElementById("m-checkin").innerText = btn.dataset.checkin;
      document.getElementById("m-checkout").innerText = btn.dataset.checkout;
      document.getElementById("m-status").innerText = btn.dataset.status;
      document.getElementById("m-amount").innerText = btn.dataset.amount;
    });
  });

  // -------------------------
  // Search + filter
  // -------------------------
  const searchInput = document.getElementById("bookingSearch");
  const statusFilter = document.getElementById("statusFilter");
  const rows = document.querySelectorAll("tbody tr");

  function filterRows() {
    const q = (searchInput?.value || "").toLowerCase();
    const status = statusFilter?.value || "";

    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      const rowStatus = row.querySelector(".pill")?.innerText || "";

      const matchText = text.includes(q);
      const matchStatus = !status || rowStatus === status;

      row.style.display = (matchText && matchStatus) ? "" : "none";
    });
  }

  searchInput?.addEventListener("input", filterRows);
  statusFilter?.addEventListener("change", filterRows);

});
</script>
{% endblock %}

{% extends layout_path %}
{% load static %}

{% block title %}Add / Edit Booking{% endblock %}

{% block content %}
<div class="">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">{{ page_title }}</h4>
    <a href="{% url 'booking_list' %}" class="btn btn-outline-secondary">
      <i class="ti ti-arrow-left icon-sm me-1"></i> Back
    </a>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
        <div class="row g-3">

          <!-- Guest -->
          <div class="col-md-4 position-relative">
            <label class="form-label">Guest</label>
            <div class="input-group">
              <span class="input-group-text"><i class="ti ti-search icon-sm"></i></span>
              <input type="text" id="guestSearch" class="form-control"
                     placeholder="Search by name / phone / email" autocomplete="off">
            </div>
            <div id="guestSuggest" class="list-group shadow-sm"
                 style="position:absolute; left:0; right:0; top:calc(100% + 4px);
                        display:none; z-index:1080; max-height:260px; overflow:auto;
                        background:var(--bs-body-bg); border:1px solid var(--bs-border-color);
                        border-radius:.5rem;"></div>
            <div class="mt-1">
              {{ form.guest }}
              {% if form.guest.errors %}
                <div class="invalid-feedback d-block">{{ form.guest.errors|striptags }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Check In / Out -->
          <div class="col-md-4">
            <label class="form-label">Check In *</label>
            {{ form.check_in }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Check Out *</label>
            {{ form.check_out }}
          </div>

          <!-- Room -->
          <div class="col-md-4">
            <label class="form-label">Select Room</label>
            <select name="room" id="roomSelect" class="form-select">
              <option value="">Select Room</option>
              {% for item in room_options %}
                <option value="{{ item.id }}" data-rate="{{ item.rate }}"
                  {% if form.instance.room_id == item.id or form.data.room == item.id|stringformat:"s" %}selected{% endif %}>
                  {{ item.label }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text" id="availabilityMsg"></div>
            {% if form.room.errors %}
              <div class="invalid-feedback d-block">{{ form.room.errors|striptags }}</div>
            {% endif %}
          </div>

          <!-- Rent -->
          <div class="col-md-4">
            <label class="form-label">Room Rent</label>
            {{ form.nightly_rate }}
          </div>

          <!-- Totals -->
          <div class="col-md-2">
            <label class="form-label">Days</label>
            <input id="nights" class="form-control" value="0" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Total Amount</label>
            <input id="grossAmount" class="form-control" value="0" readonly>
          </div>

          <div class="col-md-3">
            <label class="form-label">Discount Amount</label>
            {{ form.discount_amount }}
          </div>
          <div class="col-md-3">
            <label class="form-label">Net Amount</label>
            <input id="netAmount" class="form-control" value="0" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">Payment Amount</label>
            {{ form.payment_amount }}
          </div>
          <div class="col-md-3">
            <label class="form-label">Due</label>
            <input id="dueAmount" class="form-control" value="0" readonly>
          </div>

          <!-- Notes -->
          <div class="col-md-12 mt-2">
            <label class="form-label">Notes</label>
            {{ form.notes }}
          </div>

          <!-- Status (now for both create & edit) -->
          {% comment %} <div class="col-md-4 mt-2">
            <label class="form-label d-flex align-items-center gap-2">
              Status
              <span id="statusBadge" class="badge">—</span>
            </label>
            {{ form.status }}
            <div class="form-text">Changing status will reflect immediately in reports.</div>
          </div> {% endcomment %}

        </div>

        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            {% if is_edit %}
              <i class="ti ti-check icon-sm me-1"></i> Update Booking
            {% else %}
              <i class="ti ti-plus icon-sm me-1"></i> Add New Booking
            {% endif %}
          </button>
          <a href="{% url 'booking_create' %}" class="btn btn-light">
            <i class="ti ti-refresh icon-sm me-1"></i> Reset
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.icon-sm { font-size:1rem; line-height:1; }
.toast { min-width:280px; z-index:2000; box-shadow:0 0.5rem 1rem rgba(0,0,0,.15); }
.is-invalid { border-color: var(--bs-danger) !important; }
</style>


<script>
  // ---------- GLOBAL BOOKING CONTEXT ----------
  const CURRENT_BOOKING_ID = {{ booking_id|default:"null" }};
  const CURRENT_ROOM_ID = "{{ form.instance.room_id|default_if_none:'' }}";

  // ---------- HELPERS ----------
  const qi = (n)=>Math.max(0,Math.round(parseFloat(n)||0));
  const asIntStr = (n)=>String(qi(n));
  const dayDiff = (a,b)=>{
    if(!a||!b)return 0;
    const d1=new Date(a), d2=new Date(b);
    return d2>d1?Math.round((d2-d1)/(1000*60*60*24)):0;
  };

  // ---------- FIELD REFERENCES ----------
  const roomSelect=document.getElementById("roomSelect"),
        nightlyRate=document.getElementById("nightlyRate"),
        checkIn=document.getElementById("checkIn"),
        checkOut=document.getElementById("checkOut"),
        nightsEl=document.getElementById("nights"),
        grossEl=document.getElementById("grossAmount"),
        discountEl=document.getElementById("discountAmount"),
        netEl=document.getElementById("netAmount"),
        paymentEl=document.getElementById("paymentAmount"),
        dueEl=document.getElementById("dueAmount"),
        guestSearch=document.getElementById("guestSearch"),
        guestSuggest=document.getElementById("guestSuggest"),
        guestSelect=document.getElementById("id_guest"),
        availabilityMsg=document.getElementById("availabilityMsg"),
        submitBtn=document.querySelector("button[type='submit']");

  // ---------- TOAST ----------
  function showToast(msg,type="info"){
    const color=type==="error"?"danger":type==="success"?"success":"info";
    const t=document.createElement("div");
    t.className=`toast align-items-center text-bg-${color} border-0 position-fixed bottom-0 end-0 m-3 show`;
    t.innerHTML=`<div class='d-flex'><div class='toast-body'>${msg}</div>
      <button type='button' class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast'></button></div>`;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),3000);
  }

  // ---------- RECALC ----------
  function recalc(){
    const nights = dayDiff(checkIn.value,checkOut.value);
    nightsEl.value = asIntStr(nights);
    const rate = qi(nightlyRate.value);
    const gross = qi(nights*rate);
    grossEl.value = asIntStr(gross);

    const discount = Math.max(0,Math.min(qi(discountEl.value),gross));
    discountEl.value = asIntStr(discount);

    const net = Math.max(gross-discount,0);
    netEl.value = asIntStr(net);

    const payment = Math.max(0,Math.min(qi(paymentEl.value),net));
    paymentEl.value = asIntStr(payment);

    const due = Math.max(net-payment,0);
    dueEl.value = asIntStr(due);

    if(roomSelect.value && checkIn.value && checkOut.value){
      checkAvailability(roomSelect.value, checkIn.value, checkOut.value);
    }
  }

  // ---------- GUEST TYPEAHEAD ----------
  let gsTimer=null;
  function hideSuggest(){guestSuggest.style.display="none";guestSuggest.innerHTML="";}
  guestSearch?.addEventListener("input",()=>{
    const val=guestSearch.value.trim(); if(gsTimer)clearTimeout(gsTimer);
    if(!val){hideSuggest();return;}
    gsTimer=setTimeout(async()=>{
      try{
        const res=await fetch(`{% url 'api_guest_search' %}?q=${encodeURIComponent(val)}`);
        const j=await res.json();
        const items=j.results||[];
        if(!items.length){hideSuggest();return;}
        guestSuggest.innerHTML=items.map(it=>`
          <button type="button" class="list-group-item list-group-item-action"
                  data-id="${it.id}" data-name="${it.name}">
            ${it.label}
          </button>`).join("");
        guestSuggest.style.display="block";
      }catch(e){hideSuggest();}
    },200);
  });
  guestSuggest?.addEventListener("click",(e)=>{
    const b=e.target.closest("button[data-id]"); if(!b)return;
    guestSelect.value=b.dataset.id;
    guestSearch.value=b.dataset.name;
    hideSuggest();
  });
  document.addEventListener("click",(e)=>{
    if(!e.target.closest("#guestSuggest")&&!e.target.closest("#guestSearch")) hideSuggest();
  });

  // ---------- AVAILABILITY CHECK ----------
  async function checkAvailability(roomId,cin,cout){
    availabilityMsg.textContent="Checking availability…";
    availabilityMsg.className="form-text text-muted";
    try{
      const url=`{% url 'api_room_availability' %}?room=${encodeURIComponent(roomId)}&in=${encodeURIComponent(cin)}&out=${encodeURIComponent(cout)}`
                +(CURRENT_BOOKING_ID?`&exclude=${CURRENT_BOOKING_ID}`:"");
      const r=await fetch(url);
      const j=await r.json();
      if(j.available){
        availabilityMsg.textContent="Room is available for selected dates.";
        availabilityMsg.className="form-text text-success";
      }else{
        availabilityMsg.textContent="❌ Room not available for selected dates.";
        availabilityMsg.className="form-text text-danger";
      }
    }catch(e){
      availabilityMsg.textContent="Could not check availability.";
      availabilityMsg.className="form-text text-warning";
    }
  }

  // ---------- LOAD AVAILABLE ROOMS ----------
  async function loadAvailableRooms(cin,cout){
    if(!cin||!cout)return;
    const preId = CURRENT_ROOM_ID || roomSelect.value || "";
    roomSelect.innerHTML='<option>Loading...</option>';
    try{
      const url=`{% url 'api_rooms_available' %}?in=${encodeURIComponent(cin)}&out=${encodeURIComponent(cout)}`
                +(CURRENT_BOOKING_ID?`&exclude=${CURRENT_BOOKING_ID}`:"");
      const r=await fetch(url);
      const j=await r.json();
      const rooms=j.results||[];

      roomSelect.innerHTML='<option value="">Select Room</option>'+
        rooms.map(r=>`<option value="${r.id}" data-rate="${r.rate}">${r.label}</option>`).join("");

      // if edit mode and current room missing, add it manually
      if(preId && ![...roomSelect.options].some(o=>o.value===preId)){
        const opt=document.createElement("option");
        opt.value=preId;
        opt.dataset.rate="{{ form.instance.nightly_rate|default:'0' }}";
        opt.textContent="(Current Room)";
        roomSelect.appendChild(opt);
      }

      if(preId){ roomSelect.value=preId; }
      const opt=roomSelect.options[roomSelect.selectedIndex];
      nightlyRate.value = asIntStr(opt?.dataset?.rate||"0");
      submitBtn.disabled=false;
    }catch(e){
      roomSelect.innerHTML='<option value="">Error loading rooms</option>';
      submitBtn.disabled=true;
    }
    recalc();
  }

  // ---------- EVENTS ----------
  [checkIn,checkOut].forEach(el=>{
    el?.addEventListener("change",()=>{
      recalc();
      if(checkIn.value && checkOut.value){
        loadAvailableRooms(checkIn.value,checkOut.value);
      }
    });
  });

  roomSelect?.addEventListener("change",()=>{
    const opt=roomSelect.options[roomSelect.selectedIndex];
    nightlyRate.value=asIntStr(opt?.dataset?.rate||"0");
    recalc();
    if(roomSelect.value && checkIn.value && checkOut.value){
      checkAvailability(roomSelect.value,checkIn.value,checkOut.value);
    }
  });

  [discountEl,paymentEl].forEach(el=>{
    el?.addEventListener("input",recalc);
    el?.addEventListener("change",recalc);
    el?.addEventListener("blur",()=>{ if(el.value!=="") el.value=asIntStr(el.value); recalc(); });
  });

  document.querySelector("form").addEventListener("submit",(e)=>{
    if(!checkIn.value||!checkOut.value){
      e.preventDefault(); showToast("Please select check-in and check-out dates.","error");
    }
    if(!roomSelect.value){
      e.preventDefault(); showToast("Please select a room.","error");
    }
  });

  // ---------- INIT ON PAGE LOAD ----------
  document.addEventListener("DOMContentLoaded",()=>{
    // preselect room + rate on edit
    if(CURRENT_ROOM_ID){
      const opt=[...roomSelect.options].find(o=>o.value===CURRENT_ROOM_ID);
      if(opt){ opt.selected=true; nightlyRate.value=asIntStr(opt.dataset.rate||"0"); }
    }
    recalc();
  });

  // ---------- STATUS BADGE ----------
  function updateStatusBadge(){
    const sel=document.getElementById("id_status");
    const badge=document.getElementById("statusBadge");
    if(!sel||!badge)return;
    const map={
      "RESERVED":{text:"Reserved",cls:"bg-info"},
      "CHECKED_IN":{text:"Checked In",cls:"bg-success"},
      "CHECKED_OUT":{text:"Checked Out",cls:"bg-secondary"},
      "CANCELLED":{text:"Cancelled",cls:"bg-danger"}
    };
    const m=map[sel.value]||{text:"—",cls:"bg-light text-muted"};
    badge.className="badge "+m.cls;
    badge.textContent=m.text;
  }
  document.addEventListener("DOMContentLoaded",updateStatusBadge);
  document.getElementById("id_status")?.addEventListener("change",updateStatusBadge);
</script>


{% endblock %}
